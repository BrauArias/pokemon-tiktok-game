// server.js

const { WebcastPushConnection } = require('tiktok-live-connector');
const WebSocket = require('ws');

// Â¡IMPORTANTE! Reemplaza "braxargg" con tu propio nombre de usuario de TikTok
const tiktokUsername = "braxargg"; 
const tiktokConnection = new WebcastPushConnection(tiktokUsername);

// WebSocket Server
const wss = new WebSocket.Server({ port: 21213 });

// --- NEW: Store like counts per user and their milestones ---
let userLikeData = new Map(); // Key: uniqueId, Value: { accumulatedLikes: number, nextMilestone: number }
const USER_LIKE_MILESTONE_INTERVAL = 100;

async function startTikTokConnection() {
    try {
        await tiktokConnection.connect();
        console.log(`Connected to TikTok LIVE: @${tiktokUsername}`);

        // Listener para regalos de TikTok (existing)
        tiktokConnection.on('gift', data => {
            console.log(`${data.uniqueId} sent gift ${data.giftId} (${data.giftName})`);
            broadcastToClients({
                event: 'gift',
                data: {
                    uniqueId: data.uniqueId,
                    giftId: data.giftId,
                    giftName: data.giftName,
                    timestamp: Date.now()
                }
            });
        });

        // Listener para nuevos espectadores (existing)
        tiktokConnection.on('viewerCountUpdate', (data) => {
            console.log(`New viewer count: ${data.viewerCount}`);
            broadcastToClients({
                event: 'viewerCount',
                data: {
                    viewerCount: data.viewerCount,
                    timestamp: Date.now()
                }
            });
        });

        // --- MODIFIED: Listener for likes ---
        tiktokConnection.on('like', (data) => {
            const userId = data.uniqueId;
            const likesInThisEvent = data.likeCount || 1; // data.likeCount might not always be present or accurate for single likes

            if (!userLikeData.has(userId)) {
                userLikeData.set(userId, { accumulatedLikes: 0, nextMilestone: USER_LIKE_MILESTONE_INTERVAL });
            }

            let userData = userLikeData.get(userId);
            userData.accumulatedLikes += likesInThisEvent;
            // console.log(`${userId} sent ${likesInThisEvent} like(s). New total for user: ${userData.accumulatedLikes}. Next milestone: ${userData.nextMilestone}`);

            if (userData.accumulatedLikes >= userData.nextMilestone) {
                console.log(`ðŸŽ‰ User ${userId} reached like milestone of ${userData.nextMilestone}! Gifting common PokÃ©mon.`);
                broadcastToClients({
                    event: 'userSpecificLikeGift', // New event type
                    data: {
                        uniqueId: userId,
                        giftName: 'user_100_likes_reward', // Special name for common PokÃ©mon rarity
                        milestone: userData.nextMilestone,
                        timestamp: Date.now()
                    }
                });
                userData.nextMilestone += USER_LIKE_MILESTONE_INTERVAL; // Set the next milestone for this user
            }
            userLikeData.set(userId, userData); // Update map
        });

        tiktokConnection.on('error', (err) => {
            console.error('TikTok Connection Error:', err);
        });

        tiktokConnection.on('disconnected', () => {
            console.log('TikTok LIVE disconnected. User like counts will reset on next connection.');
            // Reset user like data when the main connection is lost
            userLikeData = new Map();
        });

    } catch (err) {
        console.error("Error connecting to TikTok:", err.message);
        console.error("Please ensure the TikTok username is correct and the account is LIVE.");
    }
}

function broadcastToClients(message) {
    wss.clients.forEach(client => {
        if (client.readyState === WebSocket.OPEN) {
            client.send(JSON.stringify(message));
        }
    });
}

startTikTokConnection();
console.log('WebSocket server started on port 21213');
console.log(`Attempting to connect to TikTok user: ${tiktokUsername}`);
